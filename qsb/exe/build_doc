#!/bin/bash

# This shell script creates the documentation for qsb, modules and addons.

echo 'build QSB documentation'

# create folder
echo 'create destination directories'
rm -rf qsb/lua/var/build/doc &>/dev/null
rm -rf qsb/lua/var/md_doc &>/dev/null
mkdir -p qsb/lua/var/build/doc/temp/
mkdir -p qsb/lua/var/md_doc/

# create html documentation
cd qsb/lua/tools
cp docbuilderstart.txt ../var/build/doc/temp/docbuilder.lua
cp docbuilderend.txt ../var/build/doc/temp/docbuilderend.txt
cd ../../../

cd qsb/lua/modules
# Add modules to html documentation index
echo "Add modules to html documentation index"
for folder in *; do
    if ! ([ -f "$folder" ];) then
        cd $folder

        DESTINATION="../../var/build/doc/temp/docbuilder.lua"
        FILENAME="modules/${folder,,}.lua"
        if [ $folder = "QSB_0_Kernel" ]; then
            FILENAME="qsb.lua"
        fi
        TITLE=$(head -n 1 title.txt)
        echo "{\"${FILENAME}\", \"${TITLE}\"}," >> $DESTINATION

        cd ../
    fi
done

# Add compatibility files to html documentation index
echo "Add compatibility files to html documentation index"
DESTINATION="../var/build/doc/temp/docbuilder.lua"
echo "{\"qsb_x_acomp.lua\", \"(X) KompatibilitÃ¤t\"}," >> $DESTINATION
DESTINATION="../var/build/source/qsb_x_acomp.lua"
find . -maxdepth 2 -iname "compatibility.lua" -type f -exec cat {} +> $DESTINATION

cd ../../../

cd qsb/lua/addons
# Add addons to html documentation index
echo "Add addons to html documentation index"
for folder in *; do
    if ! ([ -f "$folder" ];) then
        cd $folder

        DESTINATION="../../var/build/doc/temp/docbuilder.lua"
        FILENAME="addons/${folder,,}.lua"
        if ! ([ $folder = "Addon_X_Template" ];) then
            TITLE=$(head -n 1 title.txt)
            echo "{\"${FILENAME}\", \"${TITLE}\"}," >> $DESTINATION
        fi

        cd ../
    fi
done
cd ../../../

# Finish creating docbuilder
echo "Finish creating docbuilder"
cd qsb/lua/var/build/doc/temp
cat "docbuilderend.txt" >> "docbuilder.lua"
cd ../../../../../../

cd qsb/lua/tools
#Temporary remove those files that need no documentation
mv ../var/build/source/qsb_all.lua ../var/qsb_all.lua
mv ../var/build/source/qsb_comp.lua ../var/qsb_comp.lua
mv ../var/build/source/qsb.lua ../var/build/source/modules/qsb.lua

# Builds the documentations of the single modules
echo "Build the documentations of the single modules"
lua ldoc/ldoc.lua -d ../var/build/doc ../var/build/source/ &>/dev/null

# Put back those files that need no documentation
mv ../var/qsb_all.lua ../var/build/source/qsb_all.lua
mv ../var/qsb_comp.lua ../var/build/source/qsb_comp.lua
mv ../var/build/source/modules/qsb.lua ../var/build/source/qsb.lua

# Builds the documentation start page
echo "Build the documentations of the start page"
lua ../var/build/doc/temp/docbuilder.lua

# Move html files into the build directory
rm -rf ../var/build/doc/js
cp -r ../../templates/js ../var/build/doc
rm -rf ../var/build/doc/css
cp -r ../../templates/css ../var/build/doc

cd ../../../

# Create markdown documentation for modules
cd qsb/lua/modules
for folder in *; do
    if ! ([ -f "$folder" ];) then
        cd $folder

        FILENAME="modules/${folder,,}.lua"
        if [ $folder = "QSB_0_Kernel" ]; then
            FILENAME="qsb.lua"
        fi
        lua ../../tools/ldoc/ldoc.lua --ext md -d "../../var/md_doc/${FILENAME}.md" "../../var/build/source/${FILENAME}" &>/dev/null

        cd ../
    fi
done
cd ../../../

# Create markdown documentation for addons
cd qsb/lua/addons
for folder in *; do
    if ! ([ -f "$folder" ];) then
        cd $folder

        FILENAME="addons/${folder,,}.lua"
        if [ $folder = "Addon_X_Template" ]; then
            FILENAME="qsb.lua"
        fi
        lua ../../tools/ldoc/ldoc.lua --ext md -d "../../var/md_doc/${FILENAME}.md" "../var/../build/source/${FILENAME}" &>/dev/null

        cd ../
    fi
done
cd ../../../

# Create markdown documentation for compatibility
lua qsb/lua/tools/ldoc/ldoc.lua --ext md -d "qsb/lua/var/md_doc/qsb_x_acomp.lua.md" "qsb/lua/var/build/source/qsb_x_acomp.lua" &>/dev/null

# Remove temporary compatibility file
rm qsb/lua/var/build/source/qsb_x_acomp.lua

# Remove temporary files
rm -rf qsb/lua/var/build/doc/temp &>/dev/null

echo 'documentation ready'